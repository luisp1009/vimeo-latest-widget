<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vimeo Latest Widget</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="page">
    <div class="container">
      <header class="top">
        <h1>Vimeo Latest Widget</h1>
        <p>
          Enter a Vimeo username (or profile URL) → generate embed code → preview.
          No Vimeo API key required (public videos only).
        </p>
      </header>

      <section class="card">
        <div class="formGrid">
          <div class="field">
            <label for="user">Vimeo Username / Profile URL</label>
            <input id="user" placeholder="e.g. melies or https://vimeo.com/melies" value="" />
            <div class="help">Example API: https://vimeo.com/api/v2/&lt;username&gt;/videos.json</div>
          </div>

          <div class="field">
            <label for="limit">Videos</label>
            <input id="limit" type="number" min="1" max="12" value="6" />
            <div class="help">Up to 12 videos</div>
          </div>

          <div class="field">
            <label for="cols">Grid Columns</label>
            <input id="cols" type="number" min="1" max="4" value="2" />
            <div class="help">1 to 4 columns</div>
          </div>
        </div>

        <div class="actions">
          <button id="btnGenerate" class="btn btnPrimary">Generate</button>
          <button id="btnReset" class="btn btnGhost" type="button">Reset</button>
        </div>

        <div id="alert" class="alert" style="display:none;"></div>
      </section>

      <section class="card">
        <div class="cardHeader">
          <h2>Embed Code</h2>
        </div>

        <div class="codeWrap">
          <pre id="embedCode" class="code"></pre>
        </div>

        <button id="btnCopy" class="btn btnGhost" type="button" disabled>Copy to clipboard</button>
      </section>

      <section class="card">
        <div class="cardHeader rowBetween">
          <h2>Live Preview</h2>
          <div id="previewStatus" class="status">Not loaded</div>
        </div>

        <div id="previewArea" class="previewArea">
          <div class="previewEmpty">Generate an embed to preview.</div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const $user = document.getElementById("user");
    const $limit = document.getElementById("limit");
    const $cols = document.getElementById("cols");
    const $embed = document.getElementById("embedCode");
    const $alert = document.getElementById("alert");
    const $copy = document.getElementById("btnCopy");
    const $preview = document.getElementById("previewArea");
    const $status = document.getElementById("previewStatus");

    function showAlert(msg, type = "success") {
      $alert.style.display = "block";
      $alert.className = "alert " + (type === "error" ? "alertError" : "alertSuccess");
      $alert.textContent = msg;
    }

    function hideAlert() {
      $alert.style.display = "none";
      $alert.textContent = "";
    }

    function buildEmbedCode(user, limit, cols) {
      // Data-attributes pattern (like your YouTube widget):
      // No query params needed in the script src.
      const origin = location.origin;
      const div = `<div class="vimeo-latest" data-user="${user}" data-limit="${limit}" data-cols="${cols}"></div>`;
      // IMPORTANT: escaped closing script tag inside a <script> block
      const script = `<script async src="${origin}/widget.js"><\/script>`;
      return div + "\n" + script;
    }

    function setPreviewLoading() {
      $status.textContent = "Loading...";
      $preview.innerHTML = `<div class="previewLoading">Loading preview…</div>`;
    }

    async function loadPreview(user, limit, cols) {
      setPreviewLoading();

      // Create the widget mount in preview
      $preview.innerHTML = `<div class="vimeo-latest" data-user="${user}" data-limit="${limit}" data-cols="${cols}"></div>`;

      // Load widget.js fresh
      const s = document.createElement("script");
      s.src = `${location.origin}/widget.js?t=${Date.now()}`;
      s.async = true;

      s.onload = () => {
        $status.textContent = "Preview loaded";
      };
      s.onerror = () => {
        $status.textContent = "Failed to load";
      };

      document.body.appendChild(s);
    }

    document.getElementById("btnGenerate").addEventListener("click", async () => {
      hideAlert();

      const rawUser = ($user.value || "").trim();
      const limit = Math.max(1, Math.min(12, parseInt($limit.value || "6", 10)));
      const cols = Math.max(1, Math.min(4, parseInt($cols.value || "2", 10)));

      if (!rawUser) {
        showAlert("Please enter a Vimeo username or profile URL.", "error");
        $embed.textContent = "";
        $copy.disabled = true;
        $status.textContent = "Not loaded";
        $preview.innerHTML = `<div class="previewEmpty">Generate an embed to preview.</div>`;
        return;
      }

      const code = buildEmbedCode(rawUser.replace(/"/g, "&quot;"), limit, cols);
      $embed.textContent = code;
      $copy.disabled = false;

      showAlert("Embed code generated successfully!", "success");
      await loadPreview(rawUser, limit, cols);
    });

    document.getElementById("btnReset").addEventListener("click", () => {
      $user.value = "";              // ✅ no default username
      $limit.value = "6";
      $cols.value = "2";
      $embed.textContent = "";
      $copy.disabled = true;
      hideAlert();
      $status.textContent = "Not loaded";
      $preview.innerHTML = `<div class="previewEmpty">Generate an embed to preview.</div>`;
      $user.focus();
    });

    $copy.addEventListener("click", async () => {
      const txt = $embed.textContent.trim();
      if (!txt) return;
      await navigator.clipboard.writeText(txt);
      showAlert("Copied to clipboard!", "success");
    });
  </script>
</body>
</html>
